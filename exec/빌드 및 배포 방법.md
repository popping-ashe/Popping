# ğŸ”¨ ë¹Œë“œ ë°©ë²•

## í™˜ê²½

 <table>
     <tr style="font-weight: bold; font-size: 18;">
      <td align="center">ì¢…ë¥˜</td>
      <td align="center">ê¸°ìˆ ìŠ¤íƒ</td>
      <td align="center">ë²„ì „</td>
    </tr>
    <tr>
      <td align="center">JVM</td>
      <td align="center">Java</td>
      <td align="center">17.0.8</td>
    </tr>
    <tr>
      <td align="center">WAS</td>
      <td align="center">Spring Boot</td>
      <td align="center">3.1.1</td>
    </tr>
    <tr>
      <td align="center">IDE</td>
      <td align="center">IntelliJ</td>
      <td align="center">2023.1.3 (Ultimate Edition)</td>
    </tr>
    <tr>
      <td align="center"></td>
      <td align="center">Docker Desktop</td>
      <td align="center">4.22.0</td>
    </tr>
    <tr>
      <td align="center"></td>
      <td align="center">Node.js</td>
      <td align="center">18.16.1</td>
    </tr>
</table>

## ë°±ì—”ë“œ ì‹¤í–‰í•˜ê¸°

1. `https://lab.ssafy.com/s09-webmobile2-sub2/S09P12A509.git` í´ë¡  í›„ í”„ë¡œì íŠ¸ ê²½ë¡œ ë‚´ì˜ `backend` ë””ë ‰í† ë¦¬ì— ì ‘ì†
2. backend ë””ë ‰í† ë¦¬ ë‚´ì— `/localstack/docker-compose.yml` ìƒì„±
3. backend ë””ë ‰í† ë¦¬ ë‚´ì— `/src/main/resources/application.yml` ìƒì„±
4. backend ë””ë ‰í† ë¦¬ ë‚´ì— `.env` ìƒì„±
5. `docker-compose.yml` ë‚´ì˜ ì„œë¹„ìŠ¤ ì‹¤í–‰
6. ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
7. `http://localhost:8080` ì—ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸

## í™˜ê²½ ë³€ìˆ˜ ë° í”„ë¡œí¼í‹° íŒŒì¼
`docker-compose.yml`
```
version: "3.5"

services:
  mariadb:
    container_name: mariadb
    image: mariadb
    restart: always
    environment:
      - MARIADB_USER=user
      - MARIADB_PASSWORD=password
      - MARIADB_ROOT_PASSWORD=root123!
      - MARIADB_DATABASE=popping
    ports:
      - "3306:3306"
    volumes:
      - "./develop/mariadb/conf.d:/etc/mysql/conf.d"
      - "./develop/mariadb/data:/var/lib/mysql"
  redis:
    container_name: redis
    image: redis:7.2-rc3
    ports:
      - "6379:6379"
    command: redis-server --requirepass password
```

`application.yml`
```
spring:
  config:
    import: optional:file:.env[.properties]
  datasource:
    driver-class-name: org.mariadb.jdbc.Driver
    url: jdbc:mariadb://${DB_HOST}:${DB_PORT}/${DB_NAME}
    username: ${DB_USER}
    password: ${DB_PASSWORD}

  jpa:
    hibernate:
      ddl-auto: create
    properties:
      hibernate:
        format_sql: true
  data:
    redis:
      host: localhost
      port: 6379
      password: devA509

kakao:
  client:
    id: ${KAKAO_REST_API_KEY}
    secret: ${KAKAO_SECRET_KEY}
    admin : ${KAKAO_ADMIN_KEY}

google:
  client:
    id: ${GOOGLE_API_KEY}
    secret: ${GOOGLE_SECRET_KEY}

feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: full
        errorDecoder: com.example.SimpleErrorDecoder
        encoder: com.example.SimpleEncoder
token:
  secret: ${JWT_SECRET}
  access-token-expiration-time: 900000 # 15ë¶„
  refresh-token-expiration-time: 1209600000 # 2ì£¼

logging:
  level:
    org.hibernate.type: trace # ì½˜ì†”ì°½ì— ì¡°ê±´ì— ë°”ì¸ë”©ë˜ëŠ” ê°’ ë° ì¡°íšŒ ê²°ê³¼ ì¶œë ¥
    com.ashe.popping: debug

redirect-uri: "http://localhost:8081/oauth/"
```

`.env`
```
DB_HOST=localhost
DB_PORT=3306
DB_NAME=popping
DB_USER=user
DB_PASSWORD=password
KAKAO_REST_API_KEY=${ë°œê¸‰ë°›ì€ KAKAO REST API KEY}
KAKAO_SECRET_KEY=${ë°œê¸‰ë°›ì€ KAKAO SECRET KEY}
KAKAO_ADMIN_KEY=${ë°œê¸‰ë°›ì€ KAKAO ADMIN KEY}
JWT_SECRET=${JWT Secret Key}
GOOGLE_API_KEY=${ë°œê¸‰ë°›ì€ GOOGLE ANALYTICS ë°ì´í„° ìŠ¤íŠ¸ë¦¼ ì¸¡ì • ID}
GOOGLE_SECRET_KEY=${ë°œê¸‰ë°›ì€ GOOGLE SECRET KEY}
```

## í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰í•˜ê¸°

1. `https://lab.ssafy.com/s09-webmobile2-sub2/S09P12A509.git` í´ë¡  í›„ í”„ë¡œì íŠ¸ ê²½ë¡œ ë‚´ì˜ `frontend` ë””ë ‰í† ë¦¬ì— ì ‘ì†
2. `frontend` ë””ë ‰í† ë¦¬ ê²½ë¡œ ë‚´ì—ì„œ `npm install` ì‹¤í–‰
3. `frontend` ë””ë ‰í† ë¦¬ ê²½ë¡œ ë‚´ì— `.env` ìƒì„±
4. `npm run serve` ëª…ë ¹ì–´ë¡œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
5. `http://localhost:8081` ì—ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸

## í™˜ê²½ ë³€ìˆ˜ ë° í”„ë¡œí¼í‹° íŒŒì¼
`.env`
```
VUE_APP_KEY=${ì•”í˜¸í™”ì— ì‚¬ìš©ë˜ëŠ” í‚¤}
VUE_APP_IV=${ì•”í˜¸í™”ì— ì‚¬ìš©ë˜ëŠ” í‚¤}
VUE_APP_KAKAO_CLIENT_ID=${ë°œê¸‰ë°›ì€ KAKAO REST API KEY}
VUE_APP_KAKAO_API_KEY=${ë°œê¸‰ë°›ì€ KAKAO JAVASCRIPT KEY}
VUE_APP_GOOGLE_ANALYTICS_KEY=${ë°œê¸‰ë°›ì€ GOOGLE ANALYTICS KEY}
VUE_APP_KAKAO_MESSAGE_ID=${ì¹´ì¹´ì˜¤ ê³µìœ í•˜ê¸° ë©”ì‹œì§€ í…œí”Œë¦¿ ID}
VUE_APP_API_URL=${ë°±ì—”ë“œ url ex)http://localhost:8080}
VUE_APP_BASE_URL=${í”„ë¡ íŠ¸ì—”ë“œ url ex)http://localhost:8081}
```

# ğŸ’« ë°°í¬ ë°©ë²•

## í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì„¤ì •
### 1. Dockerfile ì‘ì„±
`/var/lib/jenkins/workspace/{ì•„ì´í…œ ì´ë¦„}/frontend/Dockerfile`

```
FROM node:18.16.1
WORKDIR /build

COPY package.json .

EXPOSE 3000

ADD . .
RUN npm install
CMD ["npm", "run", "build"]
```

### 1. Jenkins í™˜ê²½ ì„¤ì •

1. Jenkins - ê´€ë¦¬ - Tools - Node.js 18.16.1 ë²„ì „ ì„¤ì¹˜

2. Jenkins - Plugins - Gitlab Plugin ì„¤ì¹˜


### 2. ìë™ ë¹Œë“œ ì„¤ì •í•˜ê°€

1. í”„ë¡œì íŠ¸ ì•„ì´í…œ ìƒì„± (ë¹ˆ í”„ë¡œì íŠ¸)

2. ì†ŒìŠ¤ ì½”ë“œ ê´€ë¦¬ - Git ì„ íƒ

3. Repository URLì— Gitlab URL ì…ë ¥ í›„ Credentials ì¸ì¦ ì§„í–‰

4. Branches to build - Branch Specifier (blank for 'any') - `/release/frontend` ë¡œ ì§€ì • (ë¹Œë“œ í•  ë¸Œëœì¹˜ë¡œ ì§€ì •)

6. ë¹Œë“œ ìœ ë°œ - Build when a change is pushed to GitLab ì„ íƒ

6. Enabled GitLab triggersì˜ Push Events/Opened Merge Request Events/Approved Merge Requests (EE-only)/Comments ì„ íƒ

6. ê³ ê¸‰ - Filter branches by name `release/frontend`(ë¹Œë“œ í•  ë¸Œëœì¹˜) ì…ë ¥

7. Secret Token ìƒì„± í›„ ì €ì¥

8. Gitlab Repository ì ‘ì† í›„ Setting - Webhooks - URLê³¼ Secret Token, ë¸Œëœì¹˜ ëª… ì…ë ¥ í›„ ì €ì¥

9. ë¹Œë“œí™˜ê²½ - Provide Node & npm bin/ folder to PATH ì„ íƒ í›„ ì„¤ì¹˜í•œ NodeJS ì„ íƒ

10. Build Steps - Execute Shellì— ëª…ë ¹ì–´ ì…ë ¥
```
cd frontend
docker stop frontend-release-server
docker rm frontend-release-server 
docker build -t frontend-release-server  .
docker run -d --name frontend-release-server -v /var/lib/jenkins/workspace/popping-release-vue/frontend/dist:/build/dist frontend-release-server
```

## ë°±ì—”ë“œ ë°°í¬ ì„¤ì •
### 1. Dockerfile ì‘ì„±
`/var/lib/jenkins/workspace/{ì•„ì´í…œ ì´ë¦„}/backend/Dockerfile`
```
FROM openjdk:17

ADD ./build/libs/popping-0.0.1-SNAPSHOT.jar app.jar

ENTRYPOINT ["java", "-jar", "-Dspring.profiles.active=${PROFILE}", "./app.jar", "2>&1", "&"]
```

### 1. Jenkins í™˜ê²½ ì„¤ì •

1. Jenkins - ê´€ë¦¬ - Tools - Gradle ì„¤ì¹˜

2. Jenkins - Plugins - Gitlab Plugin ì„¤ì¹˜


### 2. ìë™ ë¹Œë“œ ì„¤ì •í•˜ê°€

1. í”„ë¡œì íŠ¸ ì•„ì´í…œ ìƒì„± (ë¹ˆ í”„ë¡œì íŠ¸)

2. ì†ŒìŠ¤ ì½”ë“œ ê´€ë¦¬ - Git ì„ íƒ

3. Repository URLì— Gitlab URL ì…ë ¥ í›„ Credentials ì¸ì¦ ì§„í–‰

4. Branches to build - Branch Specifier (blank for 'any') - `/release/backend` ë¡œ ì§€ì • (ë¹Œë“œ í•  ë¸Œëœì¹˜ë¡œ ì§€ì •)

6. ë¹Œë“œ ìœ ë°œ - Build when a change is pushed to GitLab ì„ íƒ

6. Enabled GitLab triggersì˜ Push Events/Opened Merge Request Events/Approved Merge Requests (EE-only)/Comments ì„ íƒ

6. ê³ ê¸‰ - Filter branches by name `release/backend`(ë¹Œë“œ í•  ë¸Œëœì¹˜) ì…ë ¥

7. Secret Token ìƒì„± í›„ ì €ì¥

8. Gitlab Repository ì ‘ì† í›„ Setting - Webhooks - URLê³¼ Secret Token, ë¸Œëœì¹˜ ëª… ì…ë ¥ í›„ ì €ì¥

10. Build Steps - Execute Shellì— ëª…ë ¹ì–´ ì…ë ¥
```
cd backend
/var/lib/jenkins/tools/hudson.plugins.gradle.GradleInstallation/Gradle8.1.1/bin/gradle clean bootJar
bash deploy.sh
```
`bash deploy.sh`ëŠ” ë¸”ë£¨ê·¸ë¦° ë¬´ì¤‘ë‹¨ ë°°í¬ ê´€ë ¨ ëª…ë ¹ì–´

## ë¸”ë£¨ê·¸ë¦° ë¬´ì¤‘ë‹¨ ë°°í¬ ì„¤ì •

`/frontend/deploy.sh`
```
#!/bin/bash

echo "==================== deploy start ===================="

echo " profile check..."

DOCKER_APP_NAME=frontend-release

EXIST_BLUE=$(docker ps -q -f "name=frontend-release-blue")

## profileì— ë”°ë¥¸ ì„¸íŒ…
if [ -z "$EXIST_BLUE" ];
then
        echo " setting target server blue..."

        SET_PROFILE=release-blue
	REMOVE_PROFILE=release-green
        SET_PORT=3010
else
        echo " setting target server green..."

        SET_PROFILE=release-green
	REMOVE_PROFILE=release-blue
        SET_PORT=3011
fi

echo " > profile: $SET_PROFILE"
echo " > port: $SET_PORT"

echo " > docker build"

docker build -t popping-fe-${SET_PROFILE} .

docker stop frontend-${SET_PROFILE}
docker rm frontend-${SET_PROFILE}

docker run -d -p ${SET_PORT}:3000 --name frontend-${SET_PROFILE} popping-fe-${SET_PROFILE}

echo " > Health Check"
for retry_count in $(seq 10)
do
	EXIST_CONTAINER=$(docker logs frontend-${SET_PROFILE} | grep localhost:3000)
	if [ -n "$EXIST_CONTAINER" ];
        then
                echo " >> Health check success"
                break
        fi

        if [ $retry_count -eq 10 ]
        then
                echo " >> Health check failed"
                exit 1
        fi

        echo "server is not alive yet. retry health check in 10 seconds..."
        sleep 10
done

sleep 3

echo "> change to $SET_PORT port"
echo "set \$release_url_frontend http://172.17.0.1:${SET_PORT};" | tee /etc/nginx/conf.d/release-url-frontend.inc

echo "> Nginx Reload"

echo 'devA509' | sudo -kS nginx -s reload

sleep 10

echo "> Kill reuse docker container"

docker stop frontend-$REMOVE_PROFILE

docker rm frontend-$REMOVE_PROFILE

```

`/backend/nginx-switch.sh`
```
echo "> current running port"
CURRENT_PROFILE=$(curl -s https://your.domain.com/api/profile)

if [ $CURRENT_PROFILE == release-blue ]
then
        SET_PORT=8011
elif [ $CURRENT_PROFILE == release-green ]
then
        SET_PORT=8010
else
        echo "> correspond profile is not exist. Profile:$CURRENT_PROFILE"
        echo "> use 8010 port"
        SET_PORT=8010
fi

echo "> change to $SET_PORT port"
echo "set \$release_url_backend http://172.17.0.1:${SET_PORT};" | tee /etc/nginx/conf.d/release-url-backend.inc

echo "> Nginx Reload"

echo 'devA509' | sudo -kS nginx -s reload

sleep 10

echo "> Kill reuse docker container"

docker stop backend-$CURRENT_PROFILE

docker rm backend-$CURRENT_PROFILE
```

`/backend/deploy.sh`
```
#!/bin/bash

echo "==================== deploy start ===================="

echo " profile check..."

CURRENT_PROFILE=$(curl -s https://your.domain.com/api/profile)

echo " > current profile: $CURRENT_PROFILE"

## profileì— ë”°ë¥¸ ì„¸íŒ…
if [ $CURRENT_PROFILE == release-blue ]
then
        echo " setting target server green..."

        SET_PROFILE=release-green
        SET_PORT=8011

elif [ $CURRENT_PROFILE == release-green ]
then
        echo " setting target server blue..."

        SET_PROFILE=release-blue
        SET_PORT=8010

else
        echo " not matching target... current profile : $CURRENT_PROFILE"
        echo " setting target server blue..."

        SET_PROFILE=release-blue
        SET_PORT=8010
fi

echo " > profile: $SET_PROFILE"
echo " > port: $SET_PORT"

CONTAINER_ID=$(docker container ls -f "name=backend-${SET_PROFILE}" -q)

echo " > docker build"

docker build -t popping-be-${SET_PROFILE} .

docker stop backend-${SET_PROFILE}
docker rm backend-${SET_PROFILE}

docker run -d -p ${SET_PORT}:${SET_PORT} --env PROFILE=${SET_PROFILE} --name backend-${SET_PROFILE} popping-be-${SET_PROFILE}

docker network connect db-connection-release backend-${SET_PROFILE}
docker network connect redis-connection-release backend-${SET_PROFILE}

echo " > Health Check"
for retry_count in $(seq 10)
do
        if curl -s "http://172.17.0.1:${SET_PORT}" > /dev/null
        then
                echo " >> Health check success"
                break
        fi

        if [ $retry_count -eq 10 ]
        then
                echo " >> Health check failed"
                exit 1
        fi

        echo "server is not alive yet. retry health check in 10 seconds..."
        sleep 10
done

sleep 3
bash nginx-switch.sh

```

## SSL ì¸ì¦ì„œ ë°œê¸‰


### 1. nginx ì„¤ì¹˜
```
sudo apt update
sudo apt install nginx
```

### 2. Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •

sites-available/sites-enabled ëŠ” ë”ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” Nginx ì„¤ì • ë°©ë²•ì´ë¼ê³  í•œë‹¤.
ëŒ€ì‹  conf.d ì— Nginx ì„¤ì • íŒŒì¼ì„ ë§Œë“¤ê³  ê´€ë¦¬í•œë‹¤.
```
cd /etc/nginx/conf.d
vim default.conf
```

default.conf íŒŒì¼ì„ ìƒì„±í•˜ê³  ì•„ë˜ì˜ ë‚´ìš©ì„ ì‘ì„±í•œë‹¤
```
server {
    listen 80;
    server_name your.domain.com;

    location / {
        proxy_pass http://192.168.XXX.XXX;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
    }
}
```

### 3. Certbot ì„¤ì¹˜ ë° Let's Encryptì—ì„œ SSL ì¸ì¦ì„œ ë°œê¸‰

```
sudo snap install certbot --classic
sudo certbot --nginx your.domain.com
```

### 4. Crontabìœ¼ë¡œ SSL ì¸ì¦ì„œ ìë™ ê°±ì‹  ì„¤ì •

Crontabì´ë€ ë¦¬ëˆ…ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ íŠ¹ì •í•œ ì‹œê°„ í˜¹ì€ íŠ¹ì •í•œ ì£¼ê¸°ë¡œ ëª…ë ¹ì„ ìˆ˜í–‰í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•˜ëŠ” ìŠ¤ì¼€ì¤„ë§ ë„êµ¬ì´ë‹¤.
ì•„ë˜ ëª…ë ¹ì„ ì´ìš©í•´ì„œ cron job í•˜ë‚˜ë¥¼ ìƒì„±í•œë‹¤.
```
crontab -e
```
ê¸°ë³¸ ì—ë””í„°ë¥¼ ì„ íƒí•˜ê³  ì£¼ì„ ê°€ì¥ ì•„ë˜ì— ì•„ë˜ ë‚´ìš©ì„ ì¶”ê°€í•˜ê³  ì €ì¥í•œë‹¤.
```
0 0 * * * certbot renew --post-hook "sudo service nginx reload"
```
ë§¤ì›”, ë§¤ì¼ 0ì‹œ 0ë¶„ì— certbotì„ ì‹¤í–‰í•˜ì—¬ SSL ì¸ì¦ì„œë¥¼ ê°±ì‹ í•˜ê³ , ê°±ì‹  ì´í›„ nginxì˜ ì„¤ì •íŒŒì¼ì„ reload í•´ì£¼ëŠ” ì‘ì—…ì´ë‹¤.